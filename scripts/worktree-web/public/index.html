<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>VibeTrees</title>
  <link rel="icon" type="image/svg+xml" href="/favicon.svg">

  <!-- PWA Manifest -->
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#161b22">
  <meta name="description" content="Git worktree management with integrated terminals and services">

  <!-- Apple Touch Icons -->
  <link rel="apple-touch-icon" href="/favicon.svg">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Worktrees">

  <!-- xterm.js and addons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm@5.3.0/css/xterm.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/xterm@5.3.0/lib/xterm.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xterm-addon-fit@0.8.0/lib/xterm-addon-fit.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xterm-addon-webgl@0.16.0/lib/xterm-addon-webgl.min.js"></script>

  <!-- Lucide Icons -->
  <script src="https://unpkg.com/lucide@latest"></script>

  <!-- Application Styles -->
  <link rel="stylesheet" href="/css/theme.css?v=2">
  <link rel="stylesheet" href="/css/base.css?v=2">
  <link rel="stylesheet" href="/css/sidebar.css?v=2">
  <link rel="stylesheet" href="/css/terminals.css?v=2">
  <link rel="stylesheet" href="/css/components.css?v=4">
  <link rel="stylesheet" href="/css/branch-selector.css?v=2">
  <link rel="stylesheet" href="/css/agents.css?v=2">
  <link rel="stylesheet" href="/css/sync.css?v=2">
  <link rel="stylesheet" href="/css/conflict.css?v=2">
  <link rel="stylesheet" href="/css/status-bar.css?v=2">
</head>
<body>
  <div class="app-container">
    <!-- Sidebar: Worktree Manager -->
    <div class="sidebar" id="sidebar">
      <div class="resize-handle" id="resize-handle"></div>
      <div class="sidebar-header">
        <div class="sidebar-title">
          <span class="sidebar-title-text"><i data-lucide="trees" class="lucide"></i> Worktrees</span>
          <div class="project-selector-container">
            <select id="project-selector">
              <option value="">Loading...</option>
            </select>
            <button class="small primary" onclick="showNewProjectModal()" title="Add new project">+Add</button>
            <button class="small secondary" onclick="removeCurrentProject()" title="Remove current project from VibeTrees" style="padding: 4px 8px;">
              <i data-lucide="trash-2" class="lucide-sm"></i>
            </button>
          </div>
        </div>
        <div class="sidebar-actions">
          <button id="collapse-sidebar-btn" title="Collapse sidebar"><i id="collapse-icon" data-lucide="panel-left-close" class="lucide-sm"></i></button>
          <button onclick="refreshWorktrees()" title="Refresh"><i data-lucide="rotate-cw" class="lucide-sm"></i></button>
          <button onclick="window.diagnosticsModule?.showDiagnosticsModal()" title="Run system diagnostics"><i data-lucide="stethoscope" class="lucide-sm"></i></button>
          <button onclick="window.importWorktreeModule?.showImportModal()" title="Import existing worktree"><i data-lucide="download" class="lucide-sm"></i></button>
          <button class="primary" onclick="showCreateModal()" title="Create new worktree"><i data-lucide="sprout" class="lucide-sm"></i></button>
        </div>
      </div>
      <div class="sidebar-content" id="worktrees-container">
        <div class="loading">
          <div class="spinner"></div>
          <div>Loading worktrees...</div>
        </div>
      </div>

    </div>

    <!-- Terminal Area -->
    <div class="terminal-area">
      <div class="terminal-header">
        <!--
          IMPORTANT: This is the ONLY set of terminal launch buttons in the UI.
          Do NOT create additional button sets dynamically (prevents duplicates).
          See scripts/worktree-web/public/js/tabs.js for details.
          Regression test: tests/e2e/terminal-functionality.spec.mjs
        -->
        <div class="terminal-launch-buttons">
          <button class="small" onclick="openShellForSelected()" title="Open Shell">
            <i data-lucide="terminal" class="lucide-sm"></i> Shell
          </button>
          <button class="small" onclick="openClaudeForSelected()" title="Open Claude">
            <img src="/icons/anthropic.svg" style="width: 12px; height: 12px; vertical-align: middle; filter: brightness(0) invert(1);" /> Claude
          </button>
          <button class="small" onclick="openCodexForSelected()" title="Open Codex">
            <img src="/icons/openai.svg" style="width: 12px; height: 12px; vertical-align: middle; filter: brightness(0) invert(1);" /> Codex
          </button>
          <button class="small" onclick="openWebUIForSelected()" title="Open Web UI">
            <i data-lucide="globe" class="lucide-sm"></i> Web
          </button>
          <button class="small" onclick="openLogsForSelected()" title="Open Combined Logs">
            <i data-lucide="scroll-text" class="lucide-sm"></i> Logs
          </button>
          <button class="small" id="sync-button" onclick="handleSyncButtonClick(event)" title="Sync worktree with remote" style="display: none;">
            <i data-lucide="git-pull-request-arrow" class="lucide-sm"></i> Sync
          </button>
        </div>
        <div class="terminal-tabs" id="terminal-tabs">
          <!-- Tabs will be added here dynamically -->
        </div>
      </div>
      <div class="terminal-panels" id="terminal-panels">
        <div class="empty-terminal">
          <div class="empty-terminal-header">
            <div class="empty-terminal-icon"><i data-lucide="monitor" style="width: 64px; height: 64px;"></i></div>
            <h3>Open a Terminal</h3>
            <p>Select an option to get started</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Create Worktree Modal -->
  <div id="create-modal" class="modal">
    <div class="modal-content">
      <h2 class="modal-title">Create New Worktree</h2>

      <!-- Tab Switcher -->
      <div class="tab-switcher">
        <button type="button" class="tab-button active" data-tab="new-branch" onclick="switchCreateTab('new-branch')">
          New Branch
        </button>
        <button type="button" class="tab-button" data-tab="existing-branch" onclick="switchCreateTab('existing-branch')">
          Existing Branch
        </button>
      </div>

      <form onsubmit="createWorktree(event)">
        <!-- New Branch Tab -->
        <div id="new-branch-tab" class="tab-content active">
          <div class="form-group">
            <label for="branch-name">Branch Name</label>
            <input
              type="text"
              id="branch-name"
              placeholder="feature/my-feature"
            />
          </div>
          <div class="form-group">
            <label for="from-branch">Create From</label>
            <input
              type="text"
              id="from-branch"
              placeholder="main"
              value="main"
            />
          </div>
        </div>

        <!-- Existing Branch Tab -->
        <div id="existing-branch-tab" class="tab-content">
          <div class="form-group">
            <label for="branch-search">Search Branches</label>
            <input
              type="text"
              id="branch-search"
              class="branch-search-input"
              placeholder="Search by name or commit message..."
            />
          </div>
          <div id="branch-selector-container"></div>
        </div>

        <div class="form-group">
          <label for="worktree-name">Worktree Name</label>
          <input
            type="text"
            id="worktree-name"
            placeholder="Will be auto-filled from branch"
          />
          <div style="margin-top: 4px; font-size: 11px; color: #8b949e;">
            Optional: Override the auto-generated worktree name
          </div>
        </div>

        <div class="form-group">
          <label for="agent-selector-container">AI Agent</label>
          <div id="agent-selector-container"></div>
        </div>

        <div style="margin-top: 8px; padding: 12px; background: #161b22; border: 1px solid #30363d; border-radius: 6px; font-size: 12px; color: #8b949e;">
          <strong style="color: #c9d1d9;"><i data-lucide="info" class="lucide-sm"></i> Note:</strong> All services will be included and the database will be copied from the main worktree.
        </div>
        <div id="create-progress" class="progress-container">
          <div class="progress-header">
            <div class="progress-spinner"></div>
            <div class="progress-header-text" id="progress-header-text">Creating worktree...</div>
          </div>
          <div class="progress-steps">
            <div class="progress-step pending" data-step="git">
              <div class="progress-step-icon"></div>
              <div class="progress-step-label">Create git worktree</div>
              <div class="progress-step-status" id="status-git"></div>
            </div>
            <div class="progress-step pending" data-step="database">
              <div class="progress-step-icon"></div>
              <div class="progress-step-label">Copy database</div>
              <div class="progress-step-status" id="status-database"></div>
            </div>
            <div class="progress-step pending" data-step="ports">
              <div class="progress-step-icon"></div>
              <div class="progress-step-label">Allocate ports & configure env</div>
              <div class="progress-step-status" id="status-ports"></div>
            </div>
            <div class="progress-step pending" data-step="containers">
              <div class="progress-step-icon"></div>
              <div class="progress-step-label">Start containers</div>
              <div class="progress-step-status" id="status-containers"></div>
            </div>
            <div class="progress-step pending" data-step="complete">
              <div class="progress-step-icon"></div>
              <div class="progress-step-label">Complete</div>
              <div class="progress-step-status" id="status-complete"></div>
            </div>
          </div>
          <div id="progress-output" class="progress-output"></div>
        </div>
        <div class="modal-actions">
          <button type="button" onclick="hideCreateModal()" id="cancel-button">Cancel</button>
          <button type="submit" class="primary" id="create-button">Create</button>
        </div>
      </form>
    </div>
  </div>

  <!-- New Project Modal -->
  <div id="new-project-modal" class="modal">
    <div class="modal-content">
      <h2 class="modal-title">Add New Project</h2>

      <div class="form-group">
        <label for="new-project-path">Project Folder</label>
        <div style="display: flex; gap: 8px;">
          <input
            type="text"
            id="new-project-path"
            placeholder="e.g., /Users/tim/code/my-project"
            required
            style="flex: 1;"
          />
          <button type="button" class="secondary" onclick="browseForProjectPath()" title="Browse for folder">
            <i data-lucide="folder-open" class="lucide-sm"></i> Browse
          </button>
        </div>
        <small style="color: var(--text-secondary); display: block; margin-top: 4px;">
          Select a suggestion below, browse, or type the full path
        </small>
      </div>

      <!-- Suggested Projects -->
      <div id="suggested-projects" class="suggested-projects" style="display: none;">
        <label style="font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 4px; display: block;">
          Suggested Projects
        </label>
        <div id="suggested-projects-list" class="suggested-projects-list"></div>
      </div>

      <div class="form-group">
        <label for="new-project-name">Project Name</label>
        <input
          type="text"
          id="new-project-name"
          placeholder="my-project"
          required
        />
        <small style="color: var(--text-secondary); display: block; margin-top: 4px;">
          Auto-filled from folder name
        </small>
      </div>

      <div class="modal-buttons">
        <button type="button" class="secondary" onclick="closeNewProjectModal()">Cancel</button>
        <button type="button" class="primary" onclick="createProject()">Add Project</button>
      </div>
    </div>
  </div>

  <!-- Folder Browser Modal -->
  <div id="folder-browser-modal" class="modal">
    <div class="modal-content" style="max-width: 600px;">
      <h2 class="modal-title">Browse for Project Folder</h2>

      <!-- Current Path -->
      <div class="folder-browser-path">
        <i data-lucide="folder" class="lucide-sm"></i>
        <span id="folder-browser-current-path">/</span>
      </div>

      <!-- Folder List -->
      <div id="folder-browser-list" class="folder-browser-list">
        <!-- Will be populated dynamically -->
      </div>

      <div class="modal-buttons">
        <button type="button" class="secondary" onclick="closeFolderBrowser()">Cancel</button>
        <button type="button" class="primary" onclick="selectCurrentFolder()">Select This Folder</button>
      </div>
    </div>
  </div>

  <!-- Close Worktree Modal -->
  <div id="close-modal" class="modal">
    <div class="modal-content">
      <h2 class="modal-title">Close Worktree</h2>

      <!-- Loading State -->
      <div id="close-loading" class="loading-state">
        <div class="spinner"></div>
        <div>Checking worktree status...</div>
      </div>

      <!-- Main Content (hidden until loaded) -->
      <div id="close-content" style="display: none;">
        <p>Worktree: <strong id="close-worktree-name"></strong></p>
        <p>Branch: <strong id="close-branch-name"></strong></p>

        <!-- Merge Status -->
        <div id="merge-status-container" class="status-box">
          <div id="merge-status" class="status-badge"></div>
        </div>

        <!-- Workflow Guide -->
        <div class="workflow-guide">
          <div class="workflow-title">📋 Recommended workflow:</div>
          <div class="workflow-steps">
            <div class="workflow-step">✓ Create PR with code changes</div>
            <div class="workflow-step" id="workflow-merge">Merge PR → migrations run on main</div>
            <div class="workflow-step">▶ Import test data to main</div>
          </div>
        </div>

        <!-- Close Options -->
        <form id="close-form">
          <div class="form-group">
            <div class="radio-group">
              <label class="radio-label">
                <input type="radio" name="close-action" value="no" checked>
                <div class="radio-content">
                  <div class="radio-title">Just close the worktree</div>
                  <div class="radio-description">
                    Your test data will be discarded. Your code changes are safe in your branch.
                  </div>
                </div>
              </label>

              <label class="radio-label" id="import-option">
                <input type="radio" name="close-action" value="yes">
                <div class="radio-content">
                  <div class="radio-title">Import test data to main</div>
                  <div class="radio-description">
                    Your worktree has test data that you created during development. Import it to main so you can continue using it.
                  </div>
                </div>
              </label>
            </div>
          </div>

          <!-- Database Preview -->
          <div id="database-preview" class="database-preview" style="display: none;">
            <div class="preview-title">📊 Data in worktree:</div>
            <div id="table-stats-list" class="table-stats-list"></div>
          </div>

          <!-- Update Main Option -->
          <div id="update-main-option" class="update-main-option" style="display: none;">
            <div class="update-main-button-container">
              <button type="button" class="update-main-button" onclick="openUpdateMainInstructions()">
                <i data-lucide="external-link" class="lucide-sm"></i>
                <span>Open Claude tab to update main from GitHub</span>
              </button>
              <div class="update-main-description">
                Recommended: Ensures main has your merged migrations before importing data.
              </div>
            </div>
            <div id="main-status-warning" class="warning-box" style="display: none;">
              ⚠️ Main worktree has uncommitted changes. Commit or stash them before proceeding.
            </div>
          </div>

          <!-- Warning for Not Merged -->
          <div id="not-merged-warning" class="warning-box" style="display: none;">
            ⚠️ Your branch hasn't been merged to main yet. We recommend merging your PR first, then closing the worktree to import your test data safely.
          </div>

          <!-- Branch Deletion Options -->
          <div id="branch-deletion-section" class="branch-deletion-section" style="display: none;">
            <div class="section-header">
              <h3>Branch Cleanup</h3>
            </div>

            <!-- Branch Status Box -->
            <div id="branch-status-box" class="info-box">
              <!-- Will be populated dynamically -->
            </div>

            <!-- Branch Deletion Checkbox -->
            <div class="form-group">
              <label class="checkbox-label">
                <input type="checkbox" id="delete-branch-checkbox" onchange="toggleBranchDeletionOptions()">
                <span>Also delete branch</span>
              </label>
            </div>

            <!-- Sub-options (shown when checkbox is checked) -->
            <div id="branch-deletion-options" class="branch-deletion-options" style="display: none;">
              <label class="checkbox-label indented">
                <input type="checkbox" id="delete-local-checkbox" checked>
                <span>Delete local branch</span>
              </label>
              <label class="checkbox-label indented">
                <input type="checkbox" id="delete-remote-checkbox">
                <span id="delete-remote-label">Delete on GitHub</span>
              </label>
            </div>
          </div>
        </form>
      </div>

      <div class="modal-actions">
        <button type="button" onclick="hideCloseModal()" id="close-cancel-button">Cancel</button>
        <button type="button" onclick="executeClose()" class="primary" id="close-execute-button">
          Close Worktree
        </button>
      </div>
    </div>
  </div>

  <!-- Import Worktree Modal -->
  <div id="import-modal" class="modal">
    <div class="modal-content">
      <h2 class="modal-title">Import Existing Worktree</h2>

      <!-- Loading State -->
      <div id="import-loading" class="loading-state" style="display: none;">
        <div class="spinner"></div>
        <div>Discovering worktrees...</div>
      </div>

      <!-- Error State -->
      <div id="import-error" class="error-box" style="display: none;"></div>

      <!-- Worktree List -->
      <div id="unmanaged-worktree-list" class="unmanaged-worktree-list">
        <!-- Will be populated dynamically -->
      </div>

      <div class="modal-actions">
        <button type="button" onclick="window.importWorktreeModule.hideImportModal()">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Diagnostics Modal -->
  <div id="diagnostics-modal" class="modal">
    <div class="modal-content">
      <h2 class="modal-title">System Diagnostics</h2>

      <!-- Loading State -->
      <div id="diagnostics-loading" class="loading-state" style="display: none;">
        <div class="spinner"></div>
        <div>Running diagnostics...</div>
      </div>

      <!-- Error State -->
      <div id="diagnostics-error" class="error-box" style="display: none;"></div>

      <!-- Summary -->
      <div id="diagnostics-summary" class="diagnostics-summary" style="display: none;">
        <div class="summary-item">
          <span class="summary-label">Overall Health:</span>
          <span id="overall-health" class="health-badge"></span>
        </div>
        <div class="summary-item">
          <span class="summary-label">Checks Passed:</span>
          <span id="checks-passed"></span>
        </div>
        <div class="summary-item">
          <span class="summary-label">Issues Found:</span>
          <span id="issues-found"></span>
        </div>
      </div>

      <!-- Results -->
      <div id="diagnostics-results" class="diagnostics-results">
        <!-- Will be populated dynamically -->
      </div>

      <div class="modal-actions">
        <button type="button" onclick="window.diagnosticsModule.hideDiagnosticsModal()">Close</button>
        <button type="button" onclick="window.diagnosticsModule.retryDiagnostics()" class="primary">
          <i data-lucide="rotate-cw" class="lucide-sm"></i> Refresh
        </button>
      </div>
    </div>
  </div>

  <!-- File Changes Modal -->
  <div id="changes-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2><i data-lucide="file-diff" class="lucide"></i> File Changes</h2>
        <button class="close-btn" onclick="hideChangesModal()">&times;</button>
      </div>

      <!-- Loading State -->
      <div id="changes-loading" class="loading-state" style="display: none;">
        <div class="spinner"></div>
        <div>Loading file changes...</div>
      </div>

      <!-- Content -->
      <div id="changes-content" class="modal-body" style="display: none;">
        <!-- Modified Files Section -->
        <div id="modified-section" class="changes-section">
          <h3><i data-lucide="edit" class="lucide-sm"></i> Modified Files <span id="modified-count" class="file-count"></span></h3>
          <div id="modified-files" class="file-list">
            <!-- Will be populated dynamically -->
          </div>
        </div>

        <!-- Untracked Files Section -->
        <div id="untracked-section" class="changes-section">
          <h3><i data-lucide="file-plus" class="lucide-sm"></i> Untracked Files <span id="untracked-count" class="file-count"></span></h3>
          <div id="untracked-files" class="file-list">
            <!-- Will be populated dynamically -->
          </div>
        </div>

        <!-- Empty State -->
        <div id="changes-empty" class="empty-state" style="display: none;">
          <i data-lucide="check-circle" class="lucide-lg"></i>
          <p>Working directory is clean</p>
        </div>
      </div>

      <!-- Error State -->
      <div id="changes-error" class="error-box" style="display: none;"></div>

      <div class="modal-actions">
        <button type="button" onclick="hideChangesModal()">Close</button>
      </div>
    </div>
  </div>

  <!-- Service Startup Progress Modal -->
  <div id="service-startup-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2><i data-lucide="rocket" class="lucide"></i> Starting Services</h2>
        <button class="close-btn" onclick="hideServiceStartupModal()" id="service-startup-close">&times;</button>
      </div>

      <div class="modal-body">
        <div class="progress-container active">
          <div class="progress-header">
            <div class="progress-spinner"></div>
            <div class="progress-header-text" id="service-startup-header">Initializing...</div>
          </div>

          <!-- Service list -->
          <div class="service-startup-list" id="service-startup-list">
            <!-- Will be populated dynamically with services -->
          </div>

          <!-- Log output -->
          <div id="service-startup-logs" class="progress-output"></div>
        </div>
      </div>

      <div class="modal-actions">
        <button type="button" onclick="hideServiceStartupModal()" id="service-startup-done-btn" style="display: none;" class="primary">Done</button>
      </div>
    </div>
  </div>

  <!-- Database Operations Modal -->
  <div id="database-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2><i data-lucide="database" class="lucide"></i> Database Operations</h2>
        <button class="close-btn" onclick="closeDatabaseModal()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="db-section">
          <h3>Export Database</h3>
          <div class="form-group">
            <label for="exportType">Export Type:</label>
            <select id="exportType">
              <option value="full">Full (Schema + Data)</option>
              <option value="schema">Schema Only</option>
              <option value="data">Data Only</option>
            </select>
          </div>
          <button id="exportBtn" class="primary">Export & Download</button>
        </div>

        <div class="db-section">
          <h3>Import Database</h3>
          <div class="form-group">
            <input type="file" id="importFile" accept=".sql" />
          </div>
          <div class="form-group">
            <label>
              <input type="checkbox" id="validateImport" checked />
              Validate schema compatibility
            </label>
          </div>
          <button id="importBtn" class="primary">Import</button>
          <div id="importProgress" class="progress-container" style="display: none;">
            <progress id="progressBar" max="100" value="0"></progress>
            <span id="progressText">0%</span>
          </div>
        </div>

        <div class="db-section">
          <h3>Current Schema</h3>
          <button id="viewSchemaBtn">View Schema</button>
          <pre id="schemaDisplay" style="display: none; max-height: 300px; overflow: auto; background: #f5f5f5; padding: 10px; border-radius: 4px; margin-top: 10px;"></pre>
        </div>
      </div>
    </div>
  </div>

  <!-- Context Menu -->
  <div id="context-menu" class="context-menu">
    <div class="context-menu-item" onclick="contextMenuAction('viewLogs')">
      <i data-lucide="file-text" class="lucide-sm"></i>
      <span>View Logs</span>
    </div>
    <div class="context-menu-divider"></div>
    <div class="context-menu-item" onclick="contextMenuAction('restart')">
      <i data-lucide="rotate-cw" class="lucide-sm"></i>
      <span>Restart Service</span>
    </div>
    <div class="context-menu-item" onclick="contextMenuAction('rebuild')">
      <i data-lucide="hammer" class="lucide-sm"></i>
      <span>Rebuild Service</span>
    </div>
  </div>

  <!-- Worktree Context Menu -->
  <div id="worktree-context-menu" class="context-menu">
    <div class="context-menu-item" onclick="worktreeContextMenuAction('viewAllLogs')">
      <i data-lucide="file-text" class="lucide-sm"></i>
      <span>View All Logs</span>
    </div>
    <div class="context-menu-divider"></div>
    <div class="context-menu-item" onclick="worktreeContextMenuAction('database')">
      <i data-lucide="database" class="lucide-sm"></i>
      <span>Database Operations</span>
    </div>
    <div class="context-menu-item" onclick="worktreeContextMenuAction('diagnostics')">
      <i data-lucide="stethoscope" class="lucide-sm"></i>
      <span>Run Diagnostics</span>
    </div>
    <div class="context-menu-divider"></div>
    <div class="context-menu-item danger" onclick="worktreeContextMenuAction('close')">
      <i data-lucide="x-circle" class="lucide-sm"></i>
      <span>Close Worktree</span>
    </div>
  </div>

  <!-- Status Context Menu -->
  <div id="status-context-menu" class="context-menu">
    <div class="context-menu-item" onclick="statusContextMenuAction('start')">
      <i data-lucide="play" class="lucide-sm"></i>
      <span>Start All Services</span>
    </div>
    <div class="context-menu-item" onclick="statusContextMenuAction('stop')">
      <i data-lucide="square" class="lucide-sm"></i>
      <span>Stop All Services</span>
    </div>
    <div class="context-menu-item" onclick="statusContextMenuAction('restart')">
      <i data-lucide="rotate-cw" class="lucide-sm"></i>
      <span>Restart All Services</span>
    </div>
    <div class="context-menu-divider"></div>
    <div class="context-menu-item" onclick="statusContextMenuAction('viewAllLogs')">
      <i data-lucide="file-text" class="lucide-sm"></i>
      <span>View All Logs</span>
    </div>
    <div class="context-menu-divider"></div>
    <div class="context-menu-item danger" onclick="statusContextMenuAction('close')">
      <i data-lucide="x-circle" class="lucide-sm"></i>
      <span>Close Worktree</span>
    </div>
  </div>

  <!-- Sync Prompt Modal -->
  <div id="syncModal" class="modal">
    <div class="modal-content">
      <h2>Sync Required</h2>
      <p id="syncModalMessage">main is X commits behind origin/main</p>
      <div class="modal-actions">
        <button id="syncYesBtn" class="primary">Sync & Create</button>
        <button id="syncNoBtn">Create Anyway</button>
        <button id="syncCancelBtn">Cancel</button>
      </div>
    </div>
  </div>

  <!-- New Tab Menu -->
  <div id="new-tab-menu" class="context-menu">
    <div class="context-menu-item" onclick="newTabMenuAction('shell')">
      <i data-lucide="terminal" class="lucide-sm"></i>
      <span>Shell</span>
    </div>
    <div class="context-menu-item" onclick="newTabMenuAction('claude')">
      <img src="/icons/anthropic.svg" style="width: 14px; height: 14px; filter: brightness(0) invert(1);" />
      <span>Claude</span>
    </div>
    <div class="context-menu-item" onclick="newTabMenuAction('codex')">
      <img src="/icons/openai.svg" style="width: 14px; height: 14px; filter: brightness(0) invert(1);" />
      <span>Codex</span>
    </div>
    <div class="context-menu-item" onclick="newTabMenuAction('console')">
      <i data-lucide="globe" class="lucide-sm"></i>
      <span>Console UI</span>
    </div>
  </div>

  <!-- Tab Context Menu -->
  <div id="tab-context-menu" class="context-menu">
    <div class="context-menu-item" onclick="tabContextMenuAction('refresh')">
      <i data-lucide="rotate-cw" class="lucide-sm"></i>
      <span>Refresh</span>
    </div>
    <div class="context-menu-item" onclick="tabContextMenuAction('clone')">
      <i data-lucide="copy" class="lucide-sm"></i>
      <span>Clone Tab</span>
    </div>
    <div class="context-menu-item" onclick="tabContextMenuAction('reload')">
      <i data-lucide="refresh-cw" class="lucide-sm"></i>
      <span>Reload</span>
    </div>
    <div class="context-menu-divider"></div>
    <div class="context-menu-item danger" onclick="tabContextMenuAction('kill')">
      <i data-lucide="x-octagon" class="lucide-sm"></i>
      <span>Kill Process</span>
    </div>
    <div class="context-menu-item danger" onclick="tabContextMenuAction('close')">
      <span>×</span>
      <span>Close Tab</span>
    </div>
  </div>

  <!-- Status Bar -->
  <div class="status-bar" id="status-bar">
    <!-- Branch -->
    <div class="status-segment clickable branch" onclick="copyBranchName()" title="Click to copy branch name">
      <i data-lucide="git-branch" class="status-icon"></i>
      <span class="text-full"><span class="branch-name-full">main</span></span>
      <span class="text-short"><span class="branch-name-short">main</span></span>
      <span class="text-minimal"><span class="branch-name-minimal">main</span></span>
    </div>

    <div class="status-divider">│</div>

    <!-- Ahead/Behind -->
    <div class="status-segment clickable ahead-behind-segment" onclick="openSyncDialog()" title="Click to sync">
      <i data-lucide="arrow-up" class="status-icon"></i>
      <span class="ahead-count">0</span>
      <span class="text-full">commits ahead,</span>
      <span class="text-short">ahead</span>

      <i data-lucide="arrow-down" class="status-icon"></i>
      <span class="behind-count">0</span>
      <span class="text-full">behind <span class="from-main">main</span></span>
      <span class="text-short">behind</span>
      <span class="text-minimal"></span>
    </div>

    <div class="status-divider">│</div>

    <!-- Uncommitted Changes -->
    <div class="status-segment clickable changes" onclick="showChangesModal()" title="Click to view changes">
      <span class="status-icon">●</span>
      <span class="change-count">0</span>
      <span class="text-full">modified files</span>
      <span class="text-short">files</span>
      <span class="text-minimal"></span>
    </div>

    <div class="status-divider">│</div>

    <!-- Last Commit -->
    <div class="status-segment clickable last-commit" onclick="openCommitOnGitHub()" title="Click to view commit on GitHub">
      <i data-lucide="clock" class="status-icon"></i>
      <span class="text-full">unknown</span>
      <span class="text-short">unknown</span>
      <span class="text-minimal">?</span>
    </div>

    <div class="status-divider">│</div>

    <!-- Docker Services -->
    <div class="status-segment clickable docker" onclick="showServicesModal()" title="Click to manage services">
      <span class="status-icon">🐳</span>
      <span class="service-count">0/0</span>
      <span class="text-full">services running</span>
      <span class="text-short">running</span>
      <span class="text-minimal"></span>
    </div>

    <div class="status-spacer"></div>

    <!-- Version -->
    <div class="status-segment version" title="VibeTrees version">
      <span class="version-text">v1.0.0</span>
    </div>

    <!-- WebSocket Connection Status -->
    <div class="status-segment ws-connection" id="ws-connection" title="WebSocket: Connecting...">
      <span class="ws-indicator" data-state="connecting"></span>
    </div>
  </div>

  <!-- Theme and Selection Management (Load before main.js) -->
  <script src="/js/theme.js"></script>
  <script src="/js/selection.js"></script>
  <script src="/js/database.js"></script>
  <script src="/js/branch-selector.js"></script>
  <script src="/js/agent-selector.js"></script>
  <script type="module" src="/js/import-worktree.js"></script>
  <script type="module" src="/js/diagnostics.js"></script>

  <!-- Git Sync UI Modules -->
  <script type="module" src="/js/update-notifications.js"></script>
  <script type="module" src="/js/conflict-ui.js"></script>
  <script type="module" src="/js/sync-ui.js"></script>

  <!-- Service Startup Modal -->
  <script type="module" src="/js/service-startup.js"></script>

  <!-- Initialization Progress -->
  <script type="module" src="/js/initialization.js"></script>

  <!-- Application JavaScript (ES6 Module) -->
  <script type="module" src="/js/main.js?v=8"></script>

  <!-- Toast notification -->
  <div id="toast" class="toast" style="display: none;"></div>

  <style>
  .toast {
    position: fixed;
    bottom: 2rem;
    right: 2rem;
    background: #333;
    color: white;
    padding: 1rem 1.5rem;
    border-radius: 4px;
    z-index: 2000;
    animation: slideIn 0.3s ease-out;
  }

  @keyframes slideIn {
    from {
      transform: translateX(400px);
      opacity: 0;
    }
    to {
      transform: translateX(0);
      opacity: 1;
    }
  }
  </style>

  <!-- Service Worker Registration -->
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/service-worker.js')
          .then((registration) => {
            console.log('Service Worker registered:', registration.scope);
          })
          .catch((error) => {
            console.error('Service Worker registration failed:', error);
          });
      });
    }
  </script>
</body>
</html>
